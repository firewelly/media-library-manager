# 演员记录清理合并指南

本文档详细介绍了如何使用 `merge_duplicate_actors.py` 脚本清理和合并媒体库中的重复演员记录。

## 概述

演员记录清理是维护媒体库数据质量的重要步骤。通过合并重复记录，我们可以：
- 消除数据冗余
- 规范化演员名称格式
- 保持视频与演员的正确关联
- 提高数据库查询效率

## 工具介绍

### merge_duplicate_actors.py

这是一个功能完整的Python脚本，提供以下主要功能：

1. **处理包含逗号的演员名称** (`--split-comma`)
2. **基于profile_url合并重复记录** (`--merge-url` 或 `--merge-duplicates`)
3. **基于名称合并重复记录** (`--merge-names`)

### 命令行参数

- `--dry-run`: 预览模式，不执行实际操作（默认）
- `--execute`: 执行模式，实际修改数据库
- `--limit N`: 限制处理数量为N组
- `--db-path PATH`: 指定数据库路径（默认：media_library.db）

## 清理流程

### 第一步：数据库状态检查

在开始清理之前，先检查数据库的当前状态：

```bash
# 查看演员总数和URL统计
sqlite3 media_library.db "SELECT COUNT(*) as total_actors, COUNT(DISTINCT profile_url) as unique_urls, COUNT(CASE WHEN profile_url IS NOT NULL AND profile_url != '' THEN 1 END) as actors_with_url FROM actors;"
```

### 第二步：处理包含逗号的演员名称

某些演员记录可能在爬取时将多个演员名称错误地合并到一个记录中，表现为名称字段包含逗号。

#### 检查包含逗号的记录

```bash
# 预览包含逗号的演员记录
python merge_duplicate_actors.py --split-comma --limit 5
```

#### 执行拆分操作

```bash
# 实际执行拆分（建议先小批量测试）
python merge_duplicate_actors.py --split-comma --execute --limit 1

# 处理所有包含逗号的记录
python merge_duplicate_actors.py --split-comma --execute
```

**处理逻辑：**
- 将包含逗号的名称拆分为独立的名称
- 检查拆分后的名称是否已存在于数据库中
- 如果存在，则合并到现有记录；如果不存在，则创建新记录
- 迁移所有相关的视频关联

### 第三步：基于profile_url合并重复记录

这是最重要的合并步骤，处理具有相同`profile_url`的重复演员记录。

#### 检查URL重复情况

```bash
# 预览基于URL的重复记录
python merge_duplicate_actors.py --merge-url --limit 3
```

#### 执行URL合并

```bash
# 小批量测试
python merge_duplicate_actors.py --merge-url --execute --limit 3

# 处理所有URL重复记录
python merge_duplicate_actors.py --merge-url --execute
```

**合并策略：**
- 保留ID最小的演员记录作为主记录
- 确保主记录的`name`、`name_common`、`name_traditional`字段不包含逗号
- 将所有其他名称合并到`aliases`字段中
- 迁移所有视频关联到主记录
- 删除重复记录

### 第四步：基于名称合并重复记录

处理在`name`、`name_common`、`name_traditional`或`aliases`字段中存在相同名称的演员记录。

#### 检查名称重复情况

```bash
# 预览基于名称的重复记录
python merge_duplicate_actors.py --merge-names --limit 5
```

#### 执行名称合并

```bash
# 执行基于名称的合并
python merge_duplicate_actors.py --merge-names --execute
```

### 第五步：验证清理结果

清理完成后，验证数据库状态：

```bash
# 检查最终统计
sqlite3 media_library.db "SELECT COUNT(*) as total_actors, COUNT(DISTINCT profile_url) as unique_urls, COUNT(CASE WHEN profile_url IS NOT NULL AND profile_url != '' THEN 1 END) as actors_with_url FROM actors;"

# 检查是否还有包含逗号的记录
sqlite3 media_library.db "SELECT COUNT(*) FROM actors WHERE name LIKE '%,%' OR name_common LIKE '%,%' OR name_traditional LIKE '%,%';"

# 检查是否还有URL重复
sqlite3 media_library.db "SELECT profile_url, COUNT(*) as count FROM actors WHERE profile_url IS NOT NULL AND profile_url != '' GROUP BY profile_url HAVING COUNT(*) > 1;"
```

## 完整清理流程示例

以下是一个完整的清理流程示例：

```bash
#!/bin/bash

echo "=== 开始演员记录清理 ==="

# 1. 检查初始状态
echo "初始数据库状态："
sqlite3 media_library.db "SELECT COUNT(*) as total_actors, COUNT(DISTINCT profile_url) as unique_urls, COUNT(CASE WHEN profile_url IS NOT NULL AND profile_url != '' THEN 1 END) as actors_with_url FROM actors;"

# 2. 处理包含逗号的演员名称
echo "\n=== 处理包含逗号的演员名称 ==="
python merge_duplicate_actors.py --split-comma --execute

# 3. 基于URL合并重复记录
echo "\n=== 基于URL合并重复记录 ==="
python merge_duplicate_actors.py --merge-url --execute

# 4. 基于名称合并重复记录
echo "\n=== 基于名称合并重复记录 ==="
python merge_duplicate_actors.py --merge-names --execute

# 5. 检查最终状态
echo "\n=== 清理完成，最终状态 ==="
sqlite3 media_library.db "SELECT COUNT(*) as total_actors, COUNT(DISTINCT profile_url) as unique_urls, COUNT(CASE WHEN profile_url IS NOT NULL AND profile_url != '' THEN 1 END) as actors_with_url FROM actors;"

echo "\n演员记录清理完成！"
```

## 注意事项

### 安全建议

1. **备份数据库**：在执行任何清理操作之前，务必备份数据库
   ```bash
   cp media_library.db media_library_backup_$(date +%Y%m%d_%H%M%S).db
   ```

2. **使用预览模式**：首次使用时，先用预览模式查看操作效果

3. **小批量测试**：使用`--limit`参数进行小批量测试

### 性能考虑

- 大型数据库可能需要较长处理时间
- 建议在数据库负载较低时执行清理操作
- 可以分批处理，避免长时间锁定数据库

### 数据完整性

- 脚本会自动处理视频与演员的关联关系
- 删除重复关联，确保数据一致性
- 保留所有演员名称信息在`aliases`字段中

## 常见问题

### Q: 如果合并过程中出现错误怎么办？

A: 脚本包含事务处理，出现错误时会自动回滚。建议：
- 检查错误信息
- 确保数据库文件权限正确
- 验证数据库完整性

### Q: 如何恢复误删的演员记录？

A: 从备份数据库中恢复：
```bash
cp media_library_backup_YYYYMMDD_HHMMSS.db media_library.db
```

### Q: 合并后如何验证数据正确性？

A: 可以通过以下查询验证：
```sql
-- 检查视频关联是否正确
SELECT COUNT(*) FROM video_actors va 
LEFT JOIN actors a ON va.actor_id = a.id 
WHERE a.id IS NULL;

-- 检查是否有孤立的演员记录
SELECT COUNT(*) FROM actors a 
LEFT JOIN video_actors va ON a.id = va.actor_id 
WHERE va.actor_id IS NULL;
```

## 总结

通过系统性的清理流程，可以显著提高演员数据的质量：

1. **数据规范化**：统一名称格式，消除逗号分隔的问题
2. **去重优化**：基于URL和名称的智能合并
3. **关联完整性**：保持视频与演员的正确关联
4. **别名保留**：完整保存所有演员名称变体

定期执行这些清理操作，可以确保媒体库数据的长期质量和可用性。